configfile: "config/probe.yaml"

RUN_ID = config["run_id"]

rule all:
    input:
        # DDA targets
        expand(
            "results/{run_id}/DDA/{tool_id}/probe_metrics.json",
            run_id=RUN_ID,
            tool_id=[c["tool_id"] for c in config["candidates"]["DDA"]],
        ) +
        # DIA targets
        expand(
            "results/{run_id}/DIA/{tool_id}/probe_metrics.json",
            run_id=RUN_ID,
            tool_id=[c["tool_id"] for c in config["candidates"]["DIA"]],
        )

def tool_jobs(modality):
    return config["candidates"][modality]

rule run_candidate:
    output:
        metrics="results/{run_id}/{modality}/{tool_id}/probe_metrics.json"
    params:
        preset=lambda wc: next(x["preset"] for x in tool_jobs(wc.modality) if x["tool_id"] == wc.tool_id),
        mzml=lambda wc: config["inputs"]["dda_mzml"] if wc.modality == "DDA" else config["inputs"]["dia_mzml"],
        fasta=lambda wc: config["fasta"],
    shell:
        r"""
        mkdir -p $(dirname {output.metrics})

        python workflows/probe/scripts/dispatch_tool.py \
          --registry registry/tool_registry.yaml \
          --tool-id {wildcards.tool_id} \
          --modality {wildcards.modality} \
          --preset {params.preset} \
          --mzml {params.mzml} \
          --fasta {params.fasta} \
          --emit-metrics workflows/probe/scripts/emit_metrics.py \
          --out {output.metrics}
        """
